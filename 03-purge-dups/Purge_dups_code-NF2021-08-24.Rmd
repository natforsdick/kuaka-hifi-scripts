---
title: "Purge_dups_code"
author: "sbai200"
date: "24/08/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## install Purge_dups from github:
```{bash, eval = FALSE}
git clone https://github.com/dfguan/purge_dups.git
cd purge_dups/src && make
```


## step 01: align sequencing data to the assembly and generate a paf file
```{bash, eval = FALSE}
#!/bin/bash -e

#SBATCH --job-name=make-paf
#SBATCH --output=%x.%j.out
#SBATCH --error=%x.%j.err
#SBATCH --time=00:30:00
#SBATCH --mem=10G
#SBATCH --ntasks=1
#SBATCH --profile=task 
#SBATCH --account=ga03186
#SBATCH --cpus-per-task=24

# Purge_dups pipeline
# Created by Sarah Bailey, UoA
# Modified by Nat Forsdick, 2021-08-24

# step 01: align HiFi sequencing data to the assembly and generate a paf file
# Takes one parameter - PRI or ALT

#########
# MODULES
module purge
module load minimap2/2.20-GCC-9.2.0 
#########

#########
# PARAMS
INDIR=/nesi/nobackup/ga03186/kaki-hifi-asm/asm2-hifiasm-p/
OUTDIR=/nesi/nobackup/ga03186/kaki-hifi-asm/asm2-hifiasm-p/purge_dups/
DATA=/nesi/project/ga03186/data/JF_PacBio-kaki-Steeves-Order260/processed/
PRE=asm2-hifiasm-p- # PREFIX
PRI=p_ctg
ALT=a_ctg
R1=01P- # Designate cutoffs round - either default (01) or modified (02) and whether Primary or Alternate assembly
R2=02P-
#########

#mkdir -p $OUTDIR
cd $OUTDIR

if [ "$1" == "PRI" ]; then
  minimap2 -x map-hifi -t $SLURM_CPUS_PER_TASK ${INDIR}${PRE}${PRI}.fa \
  ${DATA}m54349U_210221_005741.fastq | \
  gzip -c - > ${R1}${PRE}${PRI}-mapped.paf.gz
 
elif [ "$1" == "ALT" ]; then
  minimap2 -x map-hifi -t $SLURM_CPUS_PER_TASK ${INDIR}${PRE}${ALT}.hap-merged.fa \
  ${DATA}m54349U_210221_005741.fastq | \
  gzip -c - > ${R1}${PRE}${ALT}-merged-mapped.paf.gz
fi

```

## step 02: calculate read depth histogram and base-level read depth, generate default cutoffs, split the assembly
```{bash, eval = FALSE}
#!/bin/bash -e

# Purge_dups pipeline
# Created by Sarah Bailey, UoA
# Modified by Nat Forsdick, 2021-08-24

# step 02: calculate read depth histogram and base-level read depth, generate default cutoffs, split the assembly
# Takes one argument: PRI or ALT

#########
# PARAMS
INDIR=/nesi/nobackup/ga03186/kaki-hifi-asm/asm3-hic-hifiasm-p/
OUTDIR=/nesi/nobackup/ga03186/kaki-hifi-asm/asm3-hic-hifiasm-p/purge_dups/
PURGE_DUPS=/nesi/nobackup/ga03186/purge_dups/bin/
PRE=asm3-hic-hifiasm-p # PREFIX
PRI=p_ctg # Primary or alternate haplotigs
ALT=a_ctg
R1=01P- # Designate cutoffs round - either default (01) or modified (02) 
R2=02P-
#########

cd $OUTDIR

if [ "$1" == "PRI" ]; then 
# step 02a: Produce PB.base.cov and PB.stat files
${PURGE_DUPS}pbcstat ${R1}${PRE}-${PRI}-mapped.paf.gz

mv PB.stat ${R1}${PRE}-${PRI}-PB.stat
mv PB.base.cov ${R1}${PRE}-${PRI}-PB.base.cov
mv PB.cov.wig ${R1}${PRE}-${PRI}-PB.cov.wig

## step 02b: generate default cutoffs
${PURGE_DUPS}calcuts ${R1}${PRE}-${PRI}-PB.stat > ${R1}${PRE}-${PRI}-cutoffs 2> ${R1}${PRE}-${PRI}-calcults.log

## step 02c: split the assembly 
${PURGE_DUPS}split_fa ${INDIR}${PRE}.${PRI}.fa > ${R1}${PRE}-${PRI}.split

elif [ "$1" == "ALT" ]; then
  ${PURGE_DUPS}pbcstat ${R1}${PRE}-${ALT}-merged-mapped.paf.gz

  mv PB.stat ${R1}${PRE}-${ALT}-PB.stat
  mv PB.base.cov ${R1}${PRE}-${ALT}-PB.base.cov
  mv PB.cov.wig ${R1}${PRE}-${ALT}-PB.cov.wig
  
  ${PURGE_DUPS}calcuts ${R1}${PRE}-${ALT}-PB.stat > ${R1}${PRE}-${ALT}-cutoffs 2> ${R1}${PRE}-${ALT}-calcults.log

  ${PURGE_DUPS}split_fa ${INDIR}${R1}${PRE}.${ALT}.hap-merged.fa > ${R1}${PRE}-${ALT}.split
fi
```


## step 03: do a self-self alignment 
```{bash, eval = FALSE}
#!/bin/bash -e

#SBATCH --job-name=self-self
#SBATCH --output=%x.%j.out
#SBATCH --error=%x.%j.err
#SBATCH --time=00:03:00
#SBATCH --mem=10G
#SBATCH --ntasks=1
#SBATCH --profile=task 
#SBATCH --account=ga03186
#SBATCH --cpus-per-task=16

# Purge_dups pipeline
# Created by Sarah Bailey, UoA
# Modified by Nat Forsdick, 2021-08-24

# step 03: do a self-self alignment

#########
# MODULES
module purge
module load minimap2/2.20-GCC-9.2.0 
#########

#########
# PARAMS
OUTDIR=/nesi/nobackup/ga03186/kaki-hifi-asm/asm3-hic-hifiasm-p/purge_dups/
PRE=asm3-hic-hifiasm-p- # PREFIX
PRI=p_ctg
ALT=a_ctg
R1=01P- # Designate cutoffs round - either default (01) or modified (02) and whether Primary or Alternate assembly
R2=02P-
#########

cd $OUTDIR
# -x asm5: intra-specific asm-to-asm alignment
if [ "$1" == "PRI" ]; then 
  minimap2 -x asm5 -t $SLURM_CPUS_PER_TASK -DP ${R1}${PRE}${PRI}.split ${R1}${PRE}${PRI}.split | gzip -c - > ${R1}${PRE}${PRI}.split.self.paf.gz
elif [ "$1" == "ALT" ]; then
  minimap2 -x asm5 -t $SLURM_CPUS_PER_TASK -DP ${R1}${PRE}${ALT}.split ${R1}${PRE}${ALT}.split | gzip -c - > ${R1}${PRE}${ALT}.split.self.paf.gz
fi 
```

## 04-purge-haplotigs-overlaps.sh

step 04a: Purge haplotigs and overlaps
step 04b: Get purged primary and haplotig sequences from draft assembly


```{bash, eval = FALSE}
#!/bin/bash -e

# Purge_dups pipeline
# Created by Sarah Bailey, UoA
# Modified by Nat Forsdick, 2021-08-24

# Purge_dups pipeline
# Purge haplotigs and overlaps
# Get purged primary and haplotig sequences from draft assembly
# Takes two arguments: PRI/ALT and R1/R2

##########
# PARAMS
##########
INDIR=/nesi/nobackup/ga03186/kaki-hifi-asm/asm3-hic-hifiasm-p/
OUTDIR=/nesi/nobackup/ga03186/kaki-hifi-asm/asm3-hic-hifiasm-p/purge_dups/
PURGE_DUPS=/nesi/nobackup/ga03186/purge_dups/bin/
PRE=asm3-hic-hifiasm-p # PREFIX
PRI=p_ctg
ALT=a_ctg
R1=01P-
R2=02P- # Designate cutoffs round - either default (01) or modified (02) and whether Primary or Alternate assembly
##########

cd $OUTDIR

# R1 version
if [ "$1" == "PRI" ]; then
  if [ "$2" == "R1" ]; then
    # Step 04a: Purge haplotigs and overlaps
    ${PURGE_DUPS}purge_dups -2 -T ${R1}${PRE}-${PRI}-cutoffs -c ${R1}${PRE}-${PRI}-PB.base.cov ${R1}${PRE}-${PRI}.split.self.paf.gz > ${R1}${PRE}-${PRI}-dups.bed 2> ${R1}${PRE}-${PRI}-purge_dups.log

    # Step 04b: Get purged primary and haplotig sequences from draft assembly
    ${PURGE_DUPS}get_seqs -e ${R1}${PRE}-${PRI}-dups.bed ${INDIR}${PRE}.${PRI}.fa
  
  elif [ "$2" == "R2" ]; then
    ${PURGE_DUPS}purge_dups -2 -T ${R2}${PRE}-${PRI}-cutoffs -c ${R1}${PRE}-${PRI}-PB.base.cov ${R1}${PRE}-${PRI}.split.self.paf.gz > ${R2}${PRE}-${PRI}-dups.bed 2> ${R2}${PRE}-${PRI}-purge_dups.log

    ${PURGE_DUPS}get_seqs -e ${R2}${PRE}-${PRI}-dups.bed ${INDIR}${PRE}.${PRI}.fa
  fi

elif [ "$1" == "ALT" ]; then
  if [ "$2" == "R1" ]; then
    ${PURGE_DUPS}purge_dups -2 -T ${R1}${PRE}-${ALT}-cutoffs -c ${R1}${PRE}-${ALT}-PB.base.cov ${R1}${PRE}-${ALT}.split.self.paf.gz > ${R1}${PRE}-${ALT}-dups.bed 2> ${R1}${PRE}-${ALT}-purge_dups.log

    ${PURGE_DUPS}get_seqs -e ${R1}${ALT}-${PRI}-dups.bed ${INDIR}${R1}${PRE}.${ALT}.hap-merged.fa

  elif [ "$2" == "R2" ]; then
    ${PURGE_DUPS}purge_dups -2 -T ${R2}${PRE}${ALT}-cutoffs -c ${R1}${PRE}${ALT}-PB.base.cov ${R1}${PRE}${ALT}.split.self.paf.gz > ${R2}${PRE}${ALT}-dups.bed 2> ${R2}${PRE}${ALT}-purge_dups.log

    ${PURGE_DUPS}get_seqs -e ${R2}${PRE}${ALT}-dups.bed ${INDIR}${R2}${PRE}.${ALT}.hap-merged.fa
  fi
fi
```

##step 04b: Merge purged haplotigs (hap.fa) with the alternate draft assembly
```{bash, eval = FALSE}
#!/bin/bash -e

# Purge_dups pipeline
# Created by Sarah Bailey, UoA
# Modified by Nat Forsdick, 2021-08-24

# step 04b: merge purged haplotigs with alternate draft assembly

##########
# PARAMS
##########
INDIR=/nesi/nobackup/ga03186/kaki-hifi-asm/asm3-hic-hifiasm-p/
OUTDIR=/nesi/nobackup/ga03186/kaki-hifi-asm/asm3-hic-hifiasm-p/purge_dups/
PURGE_DUPS=/nesi/nobackup/ga03186/purge_dups/bin/
PRE=asm3-hic-hifiasm-p # PREFIX
PRI=p_ctg
ALT=a_ctg
R1=01P- # Designate cutoffs round - either default (01) or modified (02) and whether Primary or Alternate assembly
R2=02P-
##########

cd $OUTDIR

# Rename outputs
if [ "$1" == "PRI" ]; then

mv purged.fa ${R1}${PRE}${PRI}-purged.fa
mv hap.fa ${R1}${PRE}${PRI}-hap.fa

# Step 05: Merge purged haplotigs (hap.fa) with the alternate draft assembly
cat ${R1}${PRE}-${PRI}-hap.fa ${INDIR}${PRE}.${PRI}.fa > ${INDIR}${R1}${PRE}.${PRI}.hap-merged.fa

elif [ "$1" == "ALT" ]; then

mv purged.fa ${R1}${PRE}${ALT}-purged.fa
mv hap.fa ${R1}${PRE}${ALT}-hap.fa

# Step 05: Merge purged haplotigs (hap.fa) with the alternate draft assembly
cat ${R1}${PRE}-${ALT}-hap.fa ${INDIR}${PRE}.${ALT}.fa > ${INDIR}${R1}${PRE}.${ALT}.hap-merged.fa
fi

```

## step 05: to view the coverage distribution:
```{bash, eval = FALSE}
#!/bin/bash -e

# Purge_dups pipeline
# Created by Sarah Bailey, UoA
# Modified by Nat Forsdick, 2021-08-24

# step 05: to view the coverage distribution

##########
# PARAMS
PURGE_DUPS=/nesi/nobackup/ga03186/purge_dups/scripts/
OUTDIR=/nesi/nobackup/ga03186/kaki-hifi-asm/asm3-hic-hifiasm-p/purge_dups/
PRE=asm3-hic-hifiasm-p- # PREFIX
PRI=p_ctg
ALT=a_ctg
R1=01P- # Designate cutoffs round - either default (01) or modified (02) and whether Primary or Alternate assembly
R2=02P-
ASMSTATS=/nesi/project/ga03186/scripts/Assemblathon_scripts/assemblathon_stats.pl
##########

##########
# MODULES
ml purge
ml load Python
##########

cd ${OUTDIR}

if [ "$1" == "PRI" ]; then
 
  if [ "$2" == "R1" ]; then
  
    mv purged.fa ${R1}${PRE}${PRI}-purged.fa
    mv hap.fa ${R1}${PRE}${PRI}-hap.fa
    python3 ${PURGE_DUPS}hist_plot.py -c ${R1}${PRE}${PRI}-cutoffs ${R1}${PRE}${PRI}-PB.stat ${R1}${PRE}${PRI}-PB.cov.png

    # Run assemblathon stats
    $ASMSTATS ${R1}${PRE}${PRI}-purged.fa > ${R1}${PRE}${PRI}-purged.stats

  elif [ "$2" == "R2" ]; then
    mv purged.fa ${R2}${PRE}${PRI}-purged.fa
    mv hap.fa ${R2}${PRE}${PRI}-hap.fa
    python3 ${PURGE_DUPS}hist_plot.py -c ${R2}${PRE}${PRI}-cutoffs ${R1}${PRE}${PRI}-PB.stat ${R2}${PRE}${PRI}-PB.cov.png

    $ASMSTATS ${R2}${PRE}${PRI}-purged.fa > ${R2}${PRE}${PRI}-purged.stats
  fi

elif [ "$1" == "ALT" ]; then
  mv purged.fa ${R1}${PRE}${ALT}-purged.fa
  mv hap.fa ${R1}${PRE}${ALT}-hap.fa
  if [ "$2" == "R1" ]; then
    python3 ${PURGE_DUPS}hist_plot.py -c ${R1}${PRE}${ALT}-cutoffs ${R1}${PRE}${ALT}-PB.stat ${R1}${PRE}${ALT}-PB.cov.png

    # Run assemblathon stats
    $ASMSTATS ${R1}${PRE}${ALT}-purged.fa > ${R1}${PRE}${ALT}-purged.stats

  elif [ "$2" == "R2" ]; then
    mv purged.fa ${R2}${PRE}${ALT}-purged.fa
    mv hap.fa ${R2}${PRE}${ALT}-hap.fa
    python3 ${PURGE_DUPS}hist_plot.py -c ${R2}${PRE}${ALT}-cutoffs ${R1}${PRE}${ALT}-PB.stat ${R2}${PRE}${ALT}-PB.cov.png

    $ASMSTATS ${R2}${PRE}${ALT}-purged.fa > ${R2}${PRE}${ALT}-purged.stats
  fi
fi

```

## step 06: to change the cutoffs:
Modify $R1 here.
```{bash, eval = FALSE}
#!/bin/bash -e

# Purge_dups pipeline
# Created by Sarah Bailey, UoA
# Modified by Nat Forsdick, 2021-08-24

# step 06: modify cutoffs

##########
# PARAMS
PURGE_DUPS=/nesi/nobackup/ga03186/purge_dups/bin/
OUTDIR=/nesi/nobackup/ga03186/kaki-hifi-asm/asm3-hic-hifiasm-p/purge_dups/
PRE=asm3-hic-hifiasm-p- # PREFIX
PRI=p_ctg
ALT=a_ctg
R1=01P-
R2=02P- # Designate cutoffs round - either default (01) or modified (02) and whether Primary or Alternate assembly
CUTOFFS="-l2 -m15 -u60"
##########

cd ${OUTDIR}
echo $CUTOFFS
${PURGE_DUPS}calcuts ${CUTOFFS} ${R1}${PRE}${PRI}-PB.stat > ${R2}${PRE}${PRI}-cutoffs

# Following this, you need to run steps 04-07 with $ROUND modified for new cutoffs.
```
